<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Call Test</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Nunito", sans-serif;
        background: rgb(238, 174, 202);
        background: radial-gradient(
          circle,
          rgba(238, 174, 202, 1) 0%,
          rgba(148, 187, 233, 1) 100%
        );
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden;
      }

      .container {
        display: grid;
        grid-template-areas:
          "online header"
          "online video"
          "controls controls";
        gap: 15px;
        width: 100%;
        max-width: 1200px;
        padding: 20px;
        background: #edeaea;
        border-radius: 20px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        box-sizing: border-box;
      }

      header {
        grid-area: header;
        text-align: center;
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 10px;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
      }

      #onlineUsersContainer {
        grid-area: online;
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-right: 20px;
        width: 200px;
        min-width: 180px;
      }

      #onlineUsersContainer h2 {
        font-size: 1.2rem;
        color: #333;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #onlineUsers {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      #onlineUsers li {
        background: linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%);
        color: white;
        padding: 10px 0px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s;
        width: 100%;
        text-align: left;
        font-size: 0.95rem;
        font-weight: 400;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
      }

      #onlineUsers li:hover {
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        transform: translateX(5px);
      }

      #onlineUsers li::before {
        content: "â€¢";
        color: #00ff00;
        font-size: 1.2rem;
        margin-right: 10px;
      }

      #videoContainer {
        grid-area: video;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      video {
        background-color: black;
        border-radius: 20px;
        width: 48%;
        aspect-ratio: 16/9;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        object-fit: cover;
      }

      #mediaControls {
        grid-area: controls;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding-top: 15px;
      }

      .mediaButton {
        padding: 10px 20px;
        font-size: 1.1rem;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        background: #6c63ff;
        color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: background 0.3s, transform 0.2s;
        flex-grow: 1;
        margin: 0 5px;
      }

      .mediaButton:hover {
        background: #574ed8;
        transform: scale(1.1);
      }

      .mediaButton:disabled {
        background: #bbb;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .container {
          grid-template-areas:
            "header"
            "video"
            "online"
            "controls";
          grid-template-columns: 1fr;
          gap: 10px;
        }

        #videoContainer {
          flex-direction: column;
          gap: 10px;
        }

        video {
          width: 100%;
          height: auto;
        }

        #onlineUsersContainer {
          max-height: 200px;
          width: 95%;
         
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <p>Your User ID: <span id="userIdDisplay"></span></p>
      </header>

      <div id="onlineUsersContainer">
        <h2>Online Users</h2>
        <ul id="onlineUsers"></ul>
      </div>

      <div id="videoContainer">
        <video id="remoteVideo" autoplay></video>
        <video id="localVideo" autoplay muted></video>
      </div>

      <div id="mediaControls">
        <button id="muteMicButton" class="mediaButton">Mute Mic</button>
        <button id="muteCameraButton" class="mediaButton">Mute Camera</button>
        <button id="endCallButton" class="mediaButton" disabled>
          End Call
        </button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
      const userId = "user-" + Math.random().toString(36).substr(2, 9);
      document.getElementById("userIdDisplay").innerText = userId;

      const socket = io("https://socket-server-2ss7.onrender.com", {
        query: { userId },
      });
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const endCallButton = document.getElementById("endCallButton");
      const muteMicButton = document.getElementById("muteMicButton");
      const muteCameraButton = document.getElementById("muteCameraButton");
      const onlineUsersList = document.getElementById("onlineUsers");

      let localStream;
      let peerConnection;
      let micMuted = false;
      let cameraMuted = false;
      let callUserId;

      const iceServers = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          localStream = stream;
          localVideo.srcObject = stream;
          localStream.getAudioTracks()[0].enabled = false;
          localStream.getVideoTracks()[0].enabled = false;
        })
        .catch((error) => {
          console.error("Error accessing media devices.", error);
        });

      socket.on("incomingCall", ({ from, signalData }) => {
        if (confirm(`Incoming call from ${from}. Do you want to answer?`)) {
          acceptCall(from, signalData);
        } else {
          socket.emit("rejectCall", { to: from });
        }
      });

      socket.on("callAccepted", ({ signalData }) => {
        peerConnection.setRemoteDescription(
          new RTCSessionDescription(signalData)
        );
        toggleMedia(true);
      });

      socket.on("callRejected", () => {
        alert("Call was rejected.");
        resetCall();
      });

      socket.on("callEnded", () => {
        alert("Call ended.");
        resetCall();
      });

      socket.on("userBusy", () => {
        alert("The user is currently busy.");
        resetCall();
      });

      socket.on("iceCandidate", ({ candidate }) => {
        if (peerConnection) {
          peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });

      socket.on("getOnlineUsers", (onlineUsers) => {
        onlineUsersList.innerHTML = "";
        onlineUsers.forEach((onlineUserId) => {
          if (onlineUserId !== userId) {
            const userItem = document.createElement("li");
            userItem.innerText = onlineUserId;
            userItem.addEventListener("click", () => callUser(onlineUserId));
            onlineUsersList.appendChild(userItem);
          }
        });
      });

      function callUser(receiverId) {
        peerConnection = new RTCPeerConnection(iceServers);
        peerConnection.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("iceCandidate", {
              to: receiverId,
              candidate: event.candidate,
            });
          }
        };

        localStream.getTracks().forEach((track) => {
          peerConnection.addTrack(track, localStream);
        });

        peerConnection.createOffer().then((offer) => {
          peerConnection.setLocalDescription(offer);
          socket.emit("callUser", {
            receiverId,
            signalData: offer,
            callType: "video",
          });
          callUserId = receiverId;
        });

        endCallButton.disabled = false;
      }

      function acceptCall(from, signalData) {
        peerConnection = new RTCPeerConnection(iceServers);
        peerConnection.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("iceCandidate", {
              to: from,
              candidate: event.candidate,
            });
          }
        };

        localStream.getTracks().forEach((track) => {
          peerConnection.addTrack(track, localStream);
        });

        peerConnection.setRemoteDescription(
          new RTCSessionDescription(signalData)
        );
        peerConnection.createAnswer().then((answer) => {
          peerConnection.setLocalDescription(answer);
          socket.emit("answerCall", { to: from, signalData: answer });
        });

        endCallButton.disabled = false;
        toggleMedia(true);
      }

      function endCall() {
        socket.emit("endCall", { to: callUserId });
        resetCall();
      }

      function resetCall() {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        remoteVideo.srcObject = null;
        localStream.getVideoTracks()[0].enabled = false;
        localStream.getAudioTracks()[0].enabled = false;
        endCallButton.disabled = true;
        callUserId = null;
      }

      function toggleMedia(isCalling) {
        localStream
          .getAudioTracks()
          .forEach((track) => (track.enabled = !micMuted));
        localStream
          .getVideoTracks()
          .forEach((track) => (track.enabled = !cameraMuted));
        muteMicButton.innerText = micMuted ? "Unmute Mic" : "Mute Mic";
        muteCameraButton.innerText = cameraMuted
          ? "Unmute Camera"
          : "Mute Camera";

        // Update button colors based on status
        muteMicButton.style.backgroundColor = micMuted ? "#ff5e5e" : "#6c63ff";
        muteCameraButton.style.backgroundColor = cameraMuted
          ? "#ff5e5e"
          : "#6c63ff";
      }

      endCallButton.addEventListener("click", () => {
        endCall();
        // Reset button styles
        muteMicButton.style.backgroundColor = "#bbb";
        muteCameraButton.style.backgroundColor = "#bbb";
      });

      muteMicButton.addEventListener("click", () => {
        micMuted = !micMuted;
        toggleMedia();
      });

      muteCameraButton.addEventListener("click", () => {
        cameraMuted = !cameraMuted;
        toggleMedia();
      });
    </script>
  </body>
</html>
